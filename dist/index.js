"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_react=_interopRequireDefault(require("react")),_propTypes=_interopRequireDefault(require("prop-types")),_mdbreact=require("mdbreact"),_CircleLoader=_interopRequireDefault(require("react-spinners/CircleLoader")),_localforage=_interopRequireDefault(require("localforage")),_sdk=require("@enslogin/sdk");require("@fortawesome/fontawesome-free/css/all.min.css"),require("bootstrap-css-only/css/bootstrap.min.css"),require("mdbreact/dist/css/mdb.css"),require("./index.css");function _createSuper(a){var b=_isNativeReflectConstruct();return function(){var c,d=(0,_getPrototypeOf2["default"])(a);if(b){var e=(0,_getPrototypeOf2["default"])(this).constructor;c=Reflect.construct(d,arguments,e)}else c=d.apply(this,arguments);return(0,_possibleConstructorReturn2["default"])(this,c)}}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(a){return!1}}var STORE="login-with-ethereum-cache",LoginWithEthereum=/*#__PURE__*/function(a){function b(){var a;(0,_classCallCheck2["default"])(this,b);for(var d=arguments.length,e=Array(d),f=0;f<d;f++)e[f]=arguments[f];return a=c.call.apply(c,[this].concat(e)),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"state",{}),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"componentDidMount",function(){console,a.props.config.__callbacks=a.props.config.__callbacks||{};var b=a.props.config.__callbacks.resolved;a.props.config.__callbacks.resolved=function(c,d,e){return a.setState({details:"username resolved"},function(){return b&&b(c,d,e)})};var c=a.props.config.__callbacks.loading;a.props.config.__callbacks.loading=function(b,d){return a.setState({details:"fetching wallet"},function(){return c&&c(b,d)})};var d=a.props.config.__callbacks.loaded;a.props.config.__callbacks.loaded=function(b,c){return a.setState({details:"instanciating wallet"},function(){return d&&d(b,c)})},a.props.startVisible&&a.setState({modal:!0},a.connect)}),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"setProvider",function(b){return new Promise(function(c){a.setState({provider:b,modal:!1,loading:!1},function(){a.props.connect&&a.props.connect(b),b.on("accountsChanged",function(b){return 0===b.length&&a.disconnect()}),c()})})}),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"clearProvider",function(){return new Promise(function(b){a.setState({provider:void 0,modal:a.props.startVisible,loading:!1},function(){a.props.disconnect&&a.props.disconnect(),b()})})}),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"connect",/*#__PURE__*/(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function b(){var c,d;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(b.t0=!a.props.noCache,!b.t0){b.next=5;break}return b.next=4,a.getCache();case 4:b.t0=b.sent;case 5:if(c=b.t0,d=!a.props.noInjected&&window.ethereum,!c){b.next=17;break}return b.prev=8,b.next=11,a.enslogin(c);case 11:return b.abrupt("return");case 14:b.prev=14,b.t1=b["catch"](8),console.warn("Failed to load from cache: ".concat(c));case 17:if(!d){b.next=30;break}if(b.prev=18,b.t2=d.enable,!b.t2){b.next=23;break}return b.next=23,d.enable();case 23:return b.next=25,a.setProvider(d);case 25:return b.abrupt("return");case 28:b.prev=28,b.t3=b["catch"](18);case 30:a.setState({modal:!0});case 31:case"end":return b.stop();}},b,null,[[8,14],[18,28]])}))),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"disconnect",/*#__PURE__*/(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function b(){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(b.t0=a.state.provider.disable,!b.t0){b.next=4;break}return b.next=4,a.state.provider.disable();case 4:return b.next=6,a.clearCache();case 6:return b.next=8,a.clearProvider();case 8:case"end":return b.stop();}},b)}))),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"enslogin",function(b){return new Promise(/*#__PURE__*/function(){var c=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function c(d,e){var f;return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.prev=0,a.setState({loading:!0,details:void 0}),c.next=4,_sdk.ENSLoginSDK.connect(b,a.props.config);case 4:if(f=c.sent,c.t0=f.enable,!c.t0){c.next=9;break}return c.next=9,f.enable();case 9:return c.next=11,a.setProvider(f);case 11:a.props.noCache||a.setCache(b),d(),c.next=20;break;case 15:return c.prev=15,c.t1=c["catch"](0),c.next=19,a.clearCache();case 19:e(c.t1);case 20:return c.prev=20,a.setState({loading:!1,details:void 0}),c.finish(20);case 23:case"end":return c.stop();}},c,null,[[0,15,20,23]])}));return function(){return c.apply(this,arguments)}}())}),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"setCache",function(a){return _localforage["default"].setItem(STORE,a,function(a){return!!a})}),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"getCache",function(){return _localforage["default"].getItem(STORE,function(a,b){return b?null:a})}),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"clearCache",function(){return _localforage["default"].clear()}),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"toggle",function(){a.setState({modal:!a.state.modal})}),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"submit",function(b){b.preventDefault(),a.enslogin(b.target.username.value).then(function(){})["catch"](console.error)}),(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(a),"render",function(){return/*#__PURE__*/_react["default"].createElement(_react["default"].Fragment,null,/*#__PURE__*/_react["default"].createElement("div",{id:"LoginWithEthereum-Button",className:a.props.className},a.state.provider?/*#__PURE__*/_react["default"].createElement("button",{onClick:a.disconnect},"Disconnect"):/*#__PURE__*/_react["default"].createElement("button",{onClick:a.connect},"Login with Ethereum")),/*#__PURE__*/_react["default"].createElement(_mdbreact.MDBModal,{id:"LoginWithEthereum-Modal",isOpen:a.state.modal||a.state.loading,toggle:a.toggle,centered:!0},/*#__PURE__*/_react["default"].createElement("ul",{className:"nav nav-tabs d-flex"},/*#__PURE__*/_react["default"].createElement("li",{className:"nav-item flex-auto text-center"},/*#__PURE__*/_react["default"].createElement("span",{className:"nav-link active"},"Login")),/*#__PURE__*/_react["default"].createElement("li",{className:"nav-item flex-auto text-center"},/*#__PURE__*/_react["default"].createElement("a",{className:"nav-link text-muted",href:"https://github.com/ethereum/EIPs/blob/master/EIPS/eip-2525.md",target:"_blank",rel:"noopener noreferrer"},"About ENSLogin"))),/*#__PURE__*/_react["default"].createElement(_mdbreact.MDBModalBody,{className:"m-5"},!a.state.loading&&/*#__PURE__*/_react["default"].createElement("form",{onSubmit:a.submit},/*#__PURE__*/_react["default"].createElement("div",{className:"d-flex"},a.props.networks&&/*#__PURE__*/_react["default"].createElement("select",{className:"md-form md-outline",defaultValue:a.props.config.provider&&a.props.config.provider.network||"",onChange:function onChange(b){a.props.config.provider=a.props.config.provider||{},a.props.config.provider.network=b.target.value}},a.props.networks.map(function(a,b){var c=a.name,d=a.endpoint;return/*#__PURE__*/_react["default"].createElement("option",{key:b,value:d||c},c)})),/*#__PURE__*/_react["default"].createElement(_mdbreact.MDBInput,{outline:!0,name:"username",label:"username",className:"m-0"},/*#__PURE__*/_react["default"].createElement(_mdbreact.MDBIcon,{icon:"qrcode",className:"input-embeded pointer-hover text-muted",onClick:function onClick(){return a.enslogin("walletconnect.enslogin.eth")}}))),/*#__PURE__*/_react["default"].createElement("small",{className:"form-text text-muted ml-1"},"Enter your username and press [enter].")),a.state.loading&&/*#__PURE__*/_react["default"].createElement("div",{className:"d-flex align-items-center text-muted mx-2"},/*#__PURE__*/_react["default"].createElement("span",{className:"flex-auto text-center font-weight-bolder"},"Loading ",a.state.details&&"(".concat(a.state.details,")")),/*#__PURE__*/_react["default"].createElement("span",{className:"inline-embeded"},/*#__PURE__*/_react["default"].createElement(_CircleLoader["default"],{size:"1.5em",color:"#6c757d"})))),!a.state.loading&&/*#__PURE__*/_react["default"].createElement("div",{className:"d-flex justify-content-center mx-5 mb-3"},/*#__PURE__*/_react["default"].createElement("span",{className:"pointer-hover",onClick:function onClick(){return a.enslogin("metamask.enslogin.eth")}},/*#__PURE__*/_react["default"].createElement("img",{alt:"metamask",height:"30px",className:"rounded mx-2",src:"https://betoken.fund/iao/semantic/dist/themes/default/assets/images/metamask-big.png"})),/*#__PURE__*/_react["default"].createElement("span",{className:"pointer-hover",onClick:function onClick(){return a.enslogin("authereum.enslogin.eth")}},/*#__PURE__*/_react["default"].createElement("img",{alt:"authereum",height:"30px",className:"rounded mx-2",src:"https://miro.medium.com/fit/c/160/160/1*w__iPpsW58dKOv7ZU4tD2A.png"})),/*#__PURE__*/_react["default"].createElement("span",{className:"pointer-hover",onClick:function onClick(){return a.enslogin("portis.enslogin.eth")}},/*#__PURE__*/_react["default"].createElement("img",{alt:"portis",height:"30px",className:"rounded mx-2",src:"https://wallet.portis.io/805b29212ec4c056ac686d150789aeca.svg"})))))}),a}(0,_inherits2["default"])(b,a);var c=_createSuper(b);return b}(_react["default"].Component);LoginWithEthereum.propTypes={config:_propTypes["default"].object,networks:_propTypes["default"].array,connect:_propTypes["default"].func,disconnect:_propTypes["default"].func,noCache:_propTypes["default"].bool,noInjected:_propTypes["default"].bool,startVisible:_propTypes["default"].bool,className:_propTypes["default"].string},LoginWithEthereum.defaultProps={config:{provider:{network:"ropsten"},ipfs:{host:"ipfs.infura.io",port:5001,protocol:"https"}},noCache:!1,noInjected:!1,startVisible:!1,className:""};var _default=LoginWithEthereum;exports["default"]=_default;